<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CoinRadar - Cryptocurrency Tracker</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      th:href="@{/webjars/bootstrap/5.3.0/css/bootstrap.min.css}"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <style>
      .crypto-logo {
        width: 32px;
        height: 32px;
      }
      .btn-added {
        background-color: green !important;
        color: white !important;
        pointer-events: none;
        border: 1px solid green;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container-fluid">
        <a
          class="navbar-brand"
          th:href="@{/user(username=${username ?: 'defaultUsername'})}"
        >
          Coin<span>Radar</span>
        </a>
        <div class="navbar-buttons">
          <button
            id="newsButton"
            class="btn btn-3d btn-outline-light me-2"
            onclick="navigateToNews()"
          >
            News
          </button>
          <button
            id="watchlistButton"
            class="btn btn-3d btn-outline-warning me-2"
            onclick="navigateToWatchlist()"
          >
            My Watchlist
          </button>
          <a href="/" class="btn btn-3d btn-outline-danger">Log Out</a>
        </div>
      </div>
    </nav>

    <div class="container">
      <!-- Header Section -->
      <div class="header-section text-center mb-4">
        <h1>Welcome, <span th:text="${username}"></span>!</h1>
        <p>
          Keep an eye on your favorite coins and discover new market
          opportunities.
        </p>
      </div>

      <!-- Cryptocurrency Table -->
      <div class="table-responsive">
        <table class="table table-dark table-striped table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Coin</th>
              <th>Symbol</th>
              <th>Current Price (USD)</th>
              <th>Market Cap (USD)</th>
              <th>24h Change (%)</th>
              <th>Watchlist</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="crypto, iterStat : ${cryptos}">
              <td
                th:text="${(currentPage - 1) * pageSize + iterStat.index + 1}"
              ></td>
              <td>
                <img
                  th:src="${crypto.logoUrl}"
                  alt="Logo"
                  class="me-2 crypto-logo"
                />
                <span th:text="${crypto.name}">Coin Name</span>
              </td>
              <td th:text="${crypto.symbol.toUpperCase()}"></td>
              <td
                th:text="'$' + ${#numbers.formatDecimal(crypto.currentPrice, 1, 'COMMA', 2, 'POINT')}"
              ></td>
              <td
                th:text="'$' + ${#numbers.formatDecimal(crypto.marketCap, 0, 'COMMA', 0, 'POINT')}"
              ></td>
              <td
                th:classappend="${crypto.priceChangePercentage24h > 0 ? 'text-success' : 'text-danger'}"
                th:text="${#numbers.formatDecimal(crypto.priceChangePercentage24h, 1, 2)} + '%'"
              ></td>
              <td>
                <button
                  class="btn btn-outline-secondary"
                  th:data-id="${crypto.id}"
                  th:data-name="${crypto.name}"
                  th:data-symbol="${crypto.symbol}"
                  th:data-price="${crypto.currentPrice}"
                  th:data-marketcap="${crypto.marketCap}"
                  th:data-change="${crypto.priceChangePercentage24h}"
                  th:data-logo="${crypto.logoUrl}"
                  onclick="addToWatchlist(event)"
                >
                  ⭐
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <div>© 2024 CoinRadar. All rights reserved.</div>
    </footer>

    <!-- Scripts -->
    <script>
      // Navigate to the news page
      function navigateToNews() {
        window.location.href = "/user/news";
      }

      // Navigate to the watchlist page
      function navigateToWatchlist() {
        window.location.href = "/user/watchlist";
      }

      // Add to watchlist
      function addToWatchlist(event) {
        const username = "[[${username}]]";
        const cryptoId = event.target.getAttribute("data-id");
        const name = event.target.getAttribute("data-name");
        const symbol = event.target.getAttribute("data-symbol");
        const currentPrice = event.target.getAttribute("data-price");
        const marketCap = event.target.getAttribute("data-marketcap");
        const priceChangePercentage24h =
          event.target.getAttribute("data-change");
        const logoUrl = event.target.getAttribute("data-logo");

        // Make the POST request
        fetch("https://coinradar.up.railway.app/user/watchlist/add", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({
            username: username,
            id: cryptoId,
            name: name,
            symbol: symbol,
            currentPrice: currentPrice,
            marketCap: marketCap,
            priceChangePercentage24h: priceChangePercentage24h,
            logoUrl: logoUrl,
          }),
          credentials: "include", // Ensure session cookies are sent with the request
        })
          .then((response) => {
            if (response.ok) {
              event.target.style.backgroundColor = "green";
              event.target.style.color = "white";
              event.target.disabled = true;
              event.target.textContent = "Added ✔";
              alert("Added to watchlist!");
            } else {
              response
                .text()
                .then((text) => alert("Failed to add to watchlist: " + text));
            }
          })
          .catch((error) => console.error("Error:", error));
      }
    </script>
  </body>
</html>
